<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotating Alarm Clock</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#21808D">
    <meta name="description" content="Smart alarm clock with rotating sounds that change every 2 days">
    <style>
        :root {
            --color-primary: #21808D;
            --color-background: #fcfcf9;
            --color-surface: #ffffff;
            --color-text: #1f3335;
            --color-text-secondary: #626c71;
            --color-border: #a7a9a9;
            --color-success: #22c55e;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
        }

        [data-theme="dark"] {
            --color-background: #262828;
            --color-surface: #1f2121;
            --color-text: #fcfcf9;
            --color-text-secondary: #a7a9a9;
            --color-border: #626c71;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--color-border);
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .time-display {
            text-align: center;
            background: var(--color-surface);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--color-border);
        }

        .current-time {
            font-size: 48px;
            font-weight: 700;
            color: var(--color-primary);
            font-family: 'Courier New', monospace;
            margin-bottom: 10px;
        }

        .current-date {
            font-size: 18px;
            color: var(--color-text-secondary);
            margin-bottom: 15px;
        }

        .next-alarm {
            font-size: 14px;
            color: var(--color-primary);
            background: rgba(33, 128, 141, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
        }

        .debug-info {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 10px;
            padding: 10px;
            background: rgba(33, 128, 141, 0.05);
            border-radius: 5px;
            font-family: monospace;
        }

        .rotation-indicator {
            margin-bottom: 30px;
        }

        .rotation-card {
            background: var(--color-surface);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .rotation-icon {
            font-size: 24px;
            width: 50px;
            height: 50px;
            background: var(--color-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rotation-info {
            flex: 1;
        }

        .rotation-title {
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 5px;
        }

        .rotation-sound {
            font-size: 16px;
            color: var(--color-primary);
            font-weight: 500;
        }

        .rotation-timer {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .alarms-section {
            margin-bottom: 30px;
        }

        .alarms-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .alarms-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: var(--color-text);
        }

        .alarms-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .alarm-card {
            background: var(--color-surface);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--color-border);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .alarm-card.disabled {
            opacity: 0.6;
        }

        .alarm-main {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .alarm-time {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-primary);
            font-family: 'Courier New', monospace;
            min-width: 120px;
        }

        .alarm-info {
            flex: 1;
        }

        .alarm-label {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 5px;
        }

        .alarm-schedule {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 3px;
        }

        .alarm-sound {
            font-size: 12px;
            color: var(--color-primary);
        }

        .alarm-controls {
            display: flex;
            align-items: center;
        }

        .alarm-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .alarm-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .alarm-toggle input[type="checkbox"] {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--color-primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .no-alarms {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .no-alarms-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .no-alarms-text {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .no-alarms-subtext {
            font-size: 14px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            gap: 6px;
        }

        .btn--primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn--primary:hover {
            background-color: #1a6b75;
            transform: translateY(-1px);
        }

        .btn--secondary {
            background-color: transparent;
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
        }

        .btn--outline {
            background-color: transparent;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }

        .btn--outline:hover {
            background-color: var(--color-primary);
            color: white;
        }

        .btn--danger {
            background-color: var(--color-danger);
            color: white;
        }

        .btn--sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn--large {
            padding: 16px 32px;
            font-size: 16px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--color-surface);
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-text);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--color-text);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--color-border);
            border-radius: 10px;
            font-size: 16px;
            background: var(--color-background);
            color: var(--color-text);
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .days-selector {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            background: var(--color-background);
        }

        .day-checkbox input[type="checkbox"] {
            display: none;
        }

        .day-checkbox.selected {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .alarm-notification {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .alarm-notification.active {
            display: flex;
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            from { background: rgba(0, 0, 0, 0.9); }
            to { background: rgba(33, 128, 141, 0.2); }
        }

        .alarm-notification-content {
            text-align: center;
            color: white;
            max-width: 400px;
            padding: 40px;
        }

        .alarm-notification-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .alarm-notification-time {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        .alarm-notification-label {
            font-size: 24px;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .alarm-notification-actions {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 15px;
            }
            
            .current-time {
                font-size: 36px;
            }
            
            .rotation-card {
                flex-direction: column;
                text-align: center;
            }
            
            .alarm-main {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .days-selector {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }
            
            .day-checkbox {
                padding: 8px 4px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <main class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">Alarm Clock</h1>
            <div class="header-controls">
                <button class="btn btn--secondary btn--sm" id="themeToggle">
                    <span class="theme-icon">🌙</span>
                </button>
                <button class="btn btn--secondary btn--sm" id="testAlarm">
                    <span>🔔</span>
                </button>
            </div>
        </header>

        <!-- Current Time Display -->
        <section class="time-display">
            <div class="current-time" id="currentTime">12:00:00</div>
            <div class="current-date" id="currentDate">Friday, September 5, 2025</div>
            <div class="next-alarm" id="nextAlarm" style="display: none;">Next alarm in 6h 30m</div>
            <div class="debug-info" id="debugInfo">Debug info will appear here...</div>
        </section>

        <!-- Rotating Sound Indicator -->
        <section class="rotation-indicator">
            <div class="rotation-card">
                <div class="rotation-icon">🔄</div>
                <div class="rotation-info">
                    <div class="rotation-title">Current Alarm Sound</div>
                    <div class="rotation-sound" id="currentRotationSound">Classic Beep</div>
                    <div class="rotation-timer" id="rotationTimer">Changes in 1 day 5h</div>
                </div>
                <button class="btn btn--outline btn--sm" id="previewSound">Preview</button>
            </div>
        </section>

        <!-- Alarms List -->
        <section class="alarms-section">
            <div class="alarms-header">
                <h2>Your Alarms</h2>
                <button class="btn btn--primary" id="addAlarmBtn">
                    <span>+</span>
                    <span>Add Alarm</span>
                </button>
            </div>
            <div class="alarms-list" id="alarmsList">
                <div class="no-alarms">
                    <div class="no-alarms-icon">⏰</div>
                    <div class="no-alarms-text">No alarms set</div>
                    <div class="no-alarms-subtext">Tap the + button to add your first alarm</div>
                </div>
            </div>
        </section>
    </main>

    <!-- Alarm Modal -->
    <div class="modal-overlay" id="alarmModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Alarm</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="alarmForm">
                    <!-- Time Input -->
                    <div class="form-group">
                        <label for="alarmTime">Time</label>
                        <input type="time" id="alarmTime" name="alarmTime" value="07:00" required>
                    </div>

                    <!-- Alarm Label -->
                    <div class="form-group">
                        <label for="alarmLabel">Label</label>
                        <input type="text" id="alarmLabel" name="alarmLabel" placeholder="My Alarm" maxlength="50">
                    </div>

                    <!-- Days Selection -->
                    <div class="form-group">
                        <label>Repeat Days</label>
                        <div class="days-selector">
                            <div class="day-checkbox" data-day="mon">
                                <input type="checkbox" name="alarmDays" value="mon">
                                <span>Mon</span>
                            </div>
                            <div class="day-checkbox" data-day="tue">
                                <input type="checkbox" name="alarmDays" value="tue">
                                <span>Tue</span>
                            </div>
                            <div class="day-checkbox" data-day="wed">
                                <input type="checkbox" name="alarmDays" value="wed">
                                <span>Wed</span>
                            </div>
                            <div class="day-checkbox" data-day="thu">
                                <input type="checkbox" name="alarmDays" value="thu">
                                <span>Thu</span>
                            </div>
                            <div class="day-checkbox" data-day="fri">
                                <input type="checkbox" name="alarmDays" value="fri">
                                <span>Fri</span>
                            </div>
                            <div class="day-checkbox" data-day="sat">
                                <input type="checkbox" name="alarmDays" value="sat">
                                <span>Sat</span>
                            </div>
                            <div class="day-checkbox" data-day="sun">
                                <input type="checkbox" name="alarmDays" value="sun">
                                <span>Sun</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sound Selection -->
                    <div class="form-group">
                        <label for="alarmSound">Sound</label>
                        <select id="alarmSound" name="alarmSound">
                            <option value="rotating">Rotating Sound (Changes every 2 days)</option>
                            <option value="classic-beep">Classic Beep</option>
                            <option value="gentle-chimes">Gentle Chimes</option>
                            <option value="digital-bell">Digital Bell</option>
                            <option value="morning-birds">Morning Birds</option>
                            <option value="soft-piano">Soft Piano</option>
                        </select>
                    </div>

                    <!-- Volume Control -->
                    <div class="form-group">
                        <label for="alarmVolume">Volume</label>
                        <input type="range" id="alarmVolume" name="alarmVolume" min="0" max="1" step="0.1" value="0.8">
                    </div>

                    <!-- Snooze Duration -->
                    <div class="form-group">
                        <label for="alarmSnooze">Snooze Duration (minutes)</label>
                        <select id="alarmSnooze" name="alarmSnooze">
                            <option value="1">1 minute</option>
                            <option value="5" selected>5 minutes</option>
                            <option value="10">10 minutes</option>
                            <option value="15">15 minutes</option>
                        </select>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn--secondary" id="cancelBtn">Cancel</button>
                        <button type="submit" class="btn btn--primary">Save Alarm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Alarm Notification -->
    <div class="alarm-notification" id="alarmNotification">
        <div class="alarm-notification-content">
            <div class="alarm-notification-icon">⏰</div>
            <div class="alarm-notification-time" id="alarmNotificationTime">7:00 AM</div>
            <div class="alarm-notification-label" id="alarmNotificationLabel">Work Alarm</div>
            <div class="alarm-notification-actions">
                <button class="btn btn--large btn--secondary" id="snoozeAlarm">Snooze</button>
                <button class="btn btn--large btn--primary" id="stopAlarm">Stop</button>
            </div>
        </div>
    </div>

    <script>
        class AlarmClockApp {
            constructor() {
                this.alarms = [];
                this.currentAlarm = null;
                this.editingId = null;
                this.theme = 'light';
                this.rotationSeed = Math.floor(Date.now() / (1000 * 60 * 60 * 24 * 2));
                this.triggeredAlarms = new Set(); // Track triggered alarms to prevent duplicates
                
                this.alarmSounds = [
                    {name: "Classic Beep", file: "classic-beep"},
                    {name: "Gentle Chimes", file: "gentle-chimes"},
                    {name: "Digital Bell", file: "digital-bell"},
                    {name: "Morning Birds", file: "morning-birds"},
                    {name: "Soft Piano", file: "soft-piano"},
                    {name: "Ocean Waves", file: "ocean-waves"},
                    {name: "Forest Dawn", file: "forest-dawn"},
                    {name: "Electronic Pulse", file: "electronic-pulse"}
                ];
                
                this.init();
            }

            init() {
                this.loadData();
                this.bindEvents();
                this.updateTime();
                this.updateRotationDisplay();
                this.renderAlarms();
                this.startAlarmCheck();
                this.applyTheme();
                
                // Request notification permission immediately
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        console.log('Notification permission:', permission);
                    });
                }

                // Initialize audio context on first user interaction
                document.addEventListener('click', this.initAudioContext.bind(this), { once: true });
            }

            initAudioContext() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('Audio context initialized');
                } catch (e) {
                    console.log('Audio context not available');
                }
            }

            bindEvents() {
                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => this.toggleTheme());
                
                // Test alarm button
                document.getElementById('testAlarm').addEventListener('click', () => this.testAlarm());
                
                // Add alarm
                document.getElementById('addAlarmBtn').addEventListener('click', () => this.showAddAlarmModal());
                
                // Modal controls
                document.getElementById('closeModal').addEventListener('click', () => this.closeModal());
                document.getElementById('cancelBtn').addEventListener('click', () => this.closeModal());
                
                // Form submission
                document.getElementById('alarmForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveAlarm();
                });
                
                // Day checkboxes
                document.querySelectorAll('.day-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', () => {
                        const input = checkbox.querySelector('input');
                        input.checked = !input.checked;
                        checkbox.classList.toggle('selected', input.checked);
                    });
                });
                
                // Preview sound
                document.getElementById('previewSound').addEventListener('click', () => this.previewSound());
                
                // Alarm notification controls
                document.getElementById('stopAlarm').addEventListener('click', () => this.stopAlarm());
                document.getElementById('snoozeAlarm').addEventListener('click', () => this.snoozeAlarm());
                
                // Modal overlay click
                document.getElementById('alarmModal').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        this.closeModal();
                    }
                });
            }

            updateTime() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const dateStr = now.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                document.getElementById('currentTime').textContent = timeStr;
                document.getElementById('currentDate').textContent = dateStr;
                
                // Update debug info
                this.updateDebugInfo(now);
                
                setTimeout(() => this.updateTime(), 1000);
            }

            updateDebugInfo(now) {
                const currentDay = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][now.getDay()];
                const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                const enabledAlarms = this.alarms.filter(a => a.enabled).length;
                
                const debugText = `Current: ${currentDay} ${currentTime} | Active alarms: ${enabledAlarms} | Checking every 10s`;
                document.getElementById('debugInfo').textContent = debugText;
            }

            testAlarm() {
                const testAlarm = {
                    id: 'test',
                    time: '00:00', // Dummy time
                    label: 'Test Alarm',
                    days: ['mon'],
                    sound: 'classic-beep',
                    volume: 0.8,
                    snooze: 5,
                    enabled: true
                };
                
                this.triggerAlarm(testAlarm);
            }

            updateRotationDisplay() {
                const currentSound = this.getCurrentRotationSound();
                document.getElementById('currentRotationSound').textContent = currentSound.name;
                
                const nextRotation = this.getTimeUntilNextRotation();
                document.getElementById('rotationTimer').textContent = `Changes in ${nextRotation}`;
            }

            getCurrentRotationSound() {
                const soundIndex = this.rotationSeed % this.alarmSounds.length;
                return this.alarmSounds[soundIndex];
            }

            getTimeUntilNextRotation() {
                const now = Date.now();
                const rotationInterval = 2 * 24 * 60 * 60 * 1000; // 2 days
                const nextRotationTime = (this.rotationSeed + 1) * rotationInterval;
                const timeUntil = nextRotationTime - now;
                
                const days = Math.floor(timeUntil / (24 * 60 * 60 * 1000));
                const hours = Math.floor((timeUntil % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
                
                if (days > 0) {
                    return `${days}d ${hours}h`;
                } else {
                    return `${hours}h`;
                }
            }

            showAddAlarmModal() {
                this.editingId = null;
                this.resetForm();
                document.getElementById('modalTitle').textContent = 'Add New Alarm';
                document.getElementById('alarmModal').classList.add('show');
            }

            closeModal() {
                document.getElementById('alarmModal').classList.remove('show');
                this.resetForm();
            }

            resetForm() {
                document.getElementById('alarmForm').reset();
                document.getElementById('alarmTime').value = '07:00';
                document.getElementById('alarmVolume').value = '0.8';
                document.getElementById('alarmSnooze').value = '5';
                
                // Reset day checkboxes
                document.querySelectorAll('.day-checkbox').forEach(checkbox => {
                    checkbox.classList.remove('selected');
                    checkbox.querySelector('input').checked = false;
                });
                
                // Select Monday by default
                const mondayCheckbox = document.querySelector('.day-checkbox[data-day="mon"]');
                mondayCheckbox.classList.add('selected');
                mondayCheckbox.querySelector('input').checked = true;
            }

            saveAlarm() {
                const timeInput = document.getElementById('alarmTime');
                const labelInput = document.getElementById('alarmLabel');
                const soundSelect = document.getElementById('alarmSound');
                const volumeInput = document.getElementById('alarmVolume');
                const snoozeInput = document.getElementById('alarmSnooze');
                
                // Get selected days
                const selectedDays = [];
                document.querySelectorAll('.day-checkbox input:checked').forEach(checkbox => {
                    selectedDays.push(checkbox.value);
                });
                
                if (selectedDays.length === 0) {
                    alert('Please select at least one day');
                    return;
                }
                
                if (!timeInput.value) {
                    alert('Please set an alarm time');
                    return;
                }
                
                const alarm = {
                    id: this.editingId || 'alarm_' + Date.now(),
                    time: timeInput.value,
                    label: labelInput.value || 'Alarm',
                    days: selectedDays,
                    sound: soundSelect.value,
                    volume: parseFloat(volumeInput.value),
                    snooze: parseInt(snoozeInput.value),
                    enabled: true
                };
                
                if (this.editingId) {
                    const index = this.alarms.findIndex(a => a.id === this.editingId);
                    if (index !== -1) {
                        this.alarms[index] = alarm;
                    }
                } else {
                    this.alarms.push(alarm);
                }
                
                this.saveData();
                this.renderAlarms();
                this.updateNextAlarmDisplay();
                this.closeModal();
                
                // Clear triggered alarms cache when alarm is saved
                this.triggeredAlarms.clear();
            }

            editAlarm(alarmId) {
                const alarm = this.alarms.find(a => a.id === alarmId);
                if (!alarm) return;
                
                this.editingId = alarmId;
                
                document.getElementById('alarmTime').value = alarm.time;
                document.getElementById('alarmLabel').value = alarm.label;
                document.getElementById('alarmSound').value = alarm.sound;
                document.getElementById('alarmVolume').value = alarm.volume;
                document.getElementById('alarmSnooze').value = alarm.snooze;
                
                // Set day checkboxes
                document.querySelectorAll('.day-checkbox').forEach(checkbox => {
                    const input = checkbox.querySelector('input');
                    const isSelected = alarm.days.includes(input.value);
                    input.checked = isSelected;
                    checkbox.classList.toggle('selected', isSelected);
                });
                
                document.getElementById('modalTitle').textContent = 'Edit Alarm';
                document.getElementById('alarmModal').classList.add('show');
            }

            deleteAlarm(alarmId) {
                if (confirm('Are you sure you want to delete this alarm?')) {
                    this.alarms = this.alarms.filter(a => a.id !== alarmId);
                    this.saveData();
                    this.renderAlarms();
                    this.updateNextAlarmDisplay();
                    this.triggeredAlarms.delete(alarmId);
                }
            }

            toggleAlarm(alarmId) {
                const alarm = this.alarms.find(a => a.id === alarmId);
                if (alarm) {
                    alarm.enabled = !alarm.enabled;
                    this.saveData();
                    this.renderAlarms();
                    this.updateNextAlarmDisplay();
                    
                    // Clear from triggered cache when toggled
                    if (!alarm.enabled) {
                        this.triggeredAlarms.delete(alarmId);
                    }
                }
            }

            renderAlarms() {
                const alarmsList = document.getElementById('alarmsList');
                
                if (this.alarms.length === 0) {
                    alarmsList.innerHTML = `
                        <div class="no-alarms">
                            <div class="no-alarms-icon">⏰</div>
                            <div class="no-alarms-text">No alarms set</div>
                            <div class="no-alarms-subtext">Tap the + button to add your first alarm</div>
                        </div>
                    `;
                    return;
                }
                
                const alarmsHTML = this.alarms.map(alarm => {
                    const daysText = this.formatDays(alarm.days);
                    const soundName = alarm.sound === 'rotating' ? 'Rotating Sound' : 
                                     this.alarmSounds.find(s => s.file === alarm.sound)?.name || alarm.sound;
                    
                    return `
                        <div class="alarm-card ${alarm.enabled ? 'enabled' : 'disabled'}">
                            <div class="alarm-main">
                                <div class="alarm-time">${this.formatTime(alarm.time)}</div>
                                <div class="alarm-info">
                                    <div class="alarm-label">${alarm.label}</div>
                                    <div class="alarm-schedule">${daysText}</div>
                                    <div class="alarm-sound">${soundName}</div>
                                </div>
                                <div class="alarm-controls">
                                    <label class="alarm-toggle">
                                        <input type="checkbox" ${alarm.enabled ? 'checked' : ''} 
                                               onchange="app.toggleAlarm('${alarm.id}')">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="alarm-actions">
                                <button class="btn btn--sm btn--outline" onclick="app.editAlarm('${alarm.id}')">
                                    Edit
                                </button>
                                <button class="btn btn--sm btn--danger" onclick="app.deleteAlarm('${alarm.id}')">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                alarmsList.innerHTML = alarmsHTML;
            }

            formatTime(time24) {
                const [hours, minutes] = time24.split(':');
                const hour12 = hours % 12 || 12;
                const ampm = hours >= 12 ? 'PM' : 'AM';
                return `${hour12}:${minutes} ${ampm}`;
            }

            formatDays(days) {
                const dayNames = {
                    'mon': 'Mon', 'tue': 'Tue', 'wed': 'Wed', 'thu': 'Thu',
                    'fri': 'Fri', 'sat': 'Sat', 'sun': 'Sun'
                };
                
                if (days.length === 7) return 'Every day';
                if (days.length === 5 && !days.includes('sat') && !days.includes('sun')) return 'Weekdays';
                if (days.length === 2 && days.includes('sat') && days.includes('sun')) return 'Weekends';
                
                return days.map(day => dayNames[day]).join(', ');
            }

            updateNextAlarmDisplay() {
                const nextAlarm = this.getNextAlarm();
                const nextAlarmEl = document.getElementById('nextAlarm');
                
                if (nextAlarm) {
                    const timeUntil = this.getTimeUntilAlarm(nextAlarm);
                    nextAlarmEl.textContent = `Next alarm in ${timeUntil}`;
                    nextAlarmEl.style.display = 'inline-block';
                } else {
                    nextAlarmEl.style.display = 'none';
                }
            }

            getNextAlarm() {
                const enabledAlarms = this.alarms.filter(a => a.enabled);
                if (enabledAlarms.length === 0) return null;
                
                const now = new Date();
                const currentDay = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][now.getDay()];
                const currentTime = now.getHours() * 60 + now.getMinutes();
                
                let nextAlarm = null;
                let minTimeUntil = Infinity;
                
                enabledAlarms.forEach(alarm => {
                    const [hours, minutes] = alarm.time.split(':').map(Number);
                    const alarmTime = hours * 60 + minutes;
                    
                    alarm.days.forEach(day => {
                        let daysUntil = (['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].indexOf(day) - 
                                       ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].indexOf(currentDay) + 7) % 7;
                        
                        if (daysUntil === 0 && alarmTime <= currentTime) {
                            daysUntil = 7;
                        }
                        
                        const timeUntil = daysUntil * 24 * 60 + (alarmTime - currentTime);
                        
                        if (timeUntil < minTimeUntil) {
                            minTimeUntil = timeUntil;
                            nextAlarm = alarm;
                        }
                    });
                });
                
                return nextAlarm;
            }

            getTimeUntilAlarm(alarm) {
                const now = new Date();
                const currentDay = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][now.getDay()];
                const currentTime = now.getHours() * 60 + now.getMinutes();
                
                const [hours, minutes] = alarm.time.split(':').map(Number);
                const alarmTime = hours * 60 + minutes;
                
                let minTimeUntil = Infinity;
                
                alarm.days.forEach(day => {
                    let daysUntil = (['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].indexOf(day) - 
                                   ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].indexOf(currentDay) + 7) % 7;
                    
                    if (daysUntil === 0 && alarmTime <= currentTime) {
                        daysUntil = 7;
                    }
                    
                    const timeUntil = daysUntil * 24 * 60 + (alarmTime - currentTime);
                    minTimeUntil = Math.min(minTimeUntil, timeUntil);
                });
                
                const totalHours = Math.floor(minTimeUntil / 60);
                const mins = minTimeUntil % 60;
                
                if (totalHours >= 24) {
                    const days = Math.floor(totalHours / 24);
                    const remainingHours = totalHours % 24;
                    return `${days}d ${remainingHours}h ${mins}m`;
                } else {
                    return `${totalHours}h ${mins}m`;
                }
            }

            startAlarmCheck() {
                // Check every 10 seconds for more responsive alarm checking
                setInterval(() => {
                    this.checkAlarms();
                    this.updateNextAlarmDisplay();
                }, 10000);
                
                // Also check immediately
                this.checkAlarms();
            }

            checkAlarms() {
                const now = new Date();
                const currentDay = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][now.getDay()];
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const currentTime = `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`;
                
                console.log(`Checking alarms at ${currentTime} on ${currentDay}`);
                
                this.alarms.forEach(alarm => {
                    if (alarm.enabled && alarm.days.includes(currentDay)) {
                        const [alarmHour, alarmMinute] = alarm.time.split(':').map(Number);
                        
                        // Check if alarm should trigger (within 1 minute window to handle timing issues)
                        const alarmTimeInMinutes = alarmHour * 60 + alarmMinute;
                        const currentTimeInMinutes = currentHour * 60 + currentMinute;
                        const timeDiff = Math.abs(alarmTimeInMinutes - currentTimeInMinutes);
                        
                        // Create unique key for this alarm today
                        const alarmKey = `${alarm.id}_${now.getFullYear()}_${now.getMonth()}_${now.getDate()}`;
                        
                        if (timeDiff <= 1 && !this.triggeredAlarms.has(alarmKey)) {
                            console.log(`Triggering alarm: ${alarm.label} at ${alarm.time}`);
                            this.triggeredAlarms.add(alarmKey);
                            this.triggerAlarm(alarm);
                        }
                    }
                });
                
                // Clean up old triggered alarms (older than 1 day)
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayKey = `_${yesterday.getFullYear()}_${yesterday.getMonth()}_${yesterday.getDate()}`;
                
                this.triggeredAlarms.forEach(key => {
                    if (key.includes(yesterdayKey)) {
                        this.triggeredAlarms.delete(key);
                    }
                });
            }

            triggerAlarm(alarm) {
                this.currentAlarm = alarm;
                
                console.log(`Alarm triggered: ${alarm.label}`);
                
                document.getElementById('alarmNotificationTime').textContent = this.formatTime(alarm.time);
                document.getElementById('alarmNotificationLabel').textContent = alarm.label;
                document.getElementById('alarmNotification').classList.add('active');
                
                this.playAlarmSound(alarm.volume);
                
                // Browser notification
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(`🔔 ${alarm.label}`, {
                        body: `Alarm at ${this.formatTime(alarm.time)}`,
                        icon: '/icon-192.png',
                        requireInteraction: true,
                        tag: 'alarm-notification'
                    });
                }
                
                // Vibrate if supported
                if ('vibrate' in navigator) {
                    navigator.vibrate([500, 200, 500, 200, 500]);
                }

                // Auto-stop after 2 minutes if not manually stopped
                this.autoStopTimeout = setTimeout(() => {
                    if (this.currentAlarm) {
                        this.stopAlarm();
                    }
                }, 2 * 60 * 1000);
            }

            playAlarmSound(volume = 0.8) {
                if (!this.audioContext) {
                    try {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                        console.log('Audio context not available');
                        return;
                    }
                }

                // Resume audio context if suspended
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }

                const playBeep = () => {
                    try {
                        const oscillator = this.audioContext.createOscillator();
                        const gainNode = this.audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(this.audioContext.destination);
                        
                        // Create a more attention-grabbing alarm sound
                        oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(1200, this.audioContext.currentTime + 0.1);
                        oscillator.frequency.exponentialRampToValueAtTime(800, this.audioContext.currentTime + 0.2);
                        
                        gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
                        
                        oscillator.start();
                        oscillator.stop(this.audioContext.currentTime + 0.5);
                    } catch (e) {
                        console.log('Error playing beep:', e);
                    }
                };
                
                // Play initial beep
                playBeep();
                
                // Continue playing every 2 seconds
                this.alarmSoundInterval = setInterval(playBeep, 2000);
            }

            stopAlarm() {
                console.log('Stopping alarm');
                
                this.currentAlarm = null;
                document.getElementById('alarmNotification').classList.remove('active');
                
                if (this.alarmSoundInterval) {
                    clearInterval(this.alarmSoundInterval);
                    this.alarmSoundInterval = null;
                }

                if (this.autoStopTimeout) {
                    clearTimeout(this.autoStopTimeout);
                    this.autoStopTimeout = null;
                }
            }

            snoozeAlarm() {
                if (!this.currentAlarm) return;
                
                const snoozeMinutes = this.currentAlarm.snooze || 5;
                console.log(`Snoozing alarm for ${snoozeMinutes} minutes`);
                
                this.stopAlarm();
                
                setTimeout(() => {
                    if (this.currentAlarm) { // Re-check if alarm still exists
                        this.triggerAlarm(this.currentAlarm);
                    }
                }, snoozeMinutes * 60 * 1000);
                
                // Show snooze confirmation
                const notification = document.createElement('div');
                notification.innerHTML = `Alarm snoozed for ${snoozeMinutes} minutes`;
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px; 
                    background: var(--color-primary); color: white; 
                    padding: 15px 20px; border-radius: 10px; 
                    font-weight: 600; z-index: 3000;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }

            previewSound() {
                this.playAlarmSound(0.5); // Lower volume for preview
                
                const btn = document.getElementById('previewSound');
                const originalText = btn.textContent;
                btn.textContent = 'Playing...';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    if (this.alarmSoundInterval) {
                        clearInterval(this.alarmSoundInterval);
                        this.alarmSoundInterval = null;
                    }
                }, 3000);
            }

            toggleTheme() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                this.applyTheme();
                this.saveData();
            }

            applyTheme() {
                document.documentElement.setAttribute('data-theme', this.theme);
                const icon = document.querySelector('.theme-icon');
                if (icon) {
                    icon.textContent = this.theme === 'light' ? '🌙' : '☀️';
                }
            }

            loadData() {
                try {
                    const savedAlarms = localStorage.getItem('alarmClockAlarms');
                    const savedTheme = localStorage.getItem('alarmClockTheme');
                    
                    if (savedAlarms) {
                        this.alarms = JSON.parse(savedAlarms);
                    }
                    
                    if (savedTheme) {
                        this.theme = savedTheme;
                    }
                } catch (e) {
                    console.log('Error loading data:', e);
                }
            }

            saveData() {
                try {
                    localStorage.setItem('alarmClockAlarms', JSON.stringify(this.alarms));
                    localStorage.setItem('alarmClockTheme', this.theme);
                } catch (e) {
                    console.log('Error saving data:', e);
                }
            }
        }

        // Initialize app
        let app;
        document.addEventListener('DOMContentLoaded', function() {
            app = new AlarmClockApp();
        });
    </script>
</body>
</html>